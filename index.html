<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§é‡‡è´­ç®¡ç† (Ks) - æé€Ÿç‰ˆ</title>
    <style>
        /* 1. å…¨å±€å’Œå­—ä½“è®¾ç½® (Clear and Minimal) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            background-color: #f7f7f7; /* æµ…ç°è‰²èƒŒæ™¯ */
            color: #1c1c1e; /* æ·±è‰²æ–‡å­— */
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            background: #ffffff;
            padding: 30px;
            border-radius: 16px; /* æŸ”å’Œçš„åœ†è§’ */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); /* æè½»å¾®çš„é˜´å½± */
            transition: box-shadow 0.3s;
        }
        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #3a3a3c;
            text-align: center;
            margin-bottom: 25px;
        }
        
        /* 2. Tab åˆ‡æ¢æ ·å¼ (Segmented Control Style) */
        .tabs {
            display: flex;
            background-color: #f0f0f0; 
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 30px;
        }
        .tab-button {
            flex-grow: 1;
            padding: 10px 15px;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: 600;
            color: #8e8e93; 
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
        }
        .tab-button.active {
            background-color: #ffffff; 
            color: #1c1c1e; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
        }
        .tab-content {
            display: none;
            padding: 10px 0;
        }
        .tab-content.active {
            display: block;
        }

        /* 3. ä¸‹å•é¡µé¢ (é€‰å“) æ ·å¼ */
        #product-list h2 {
            font-size: 18px;
            font-weight: 600;
            color: #5856d6; 
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e5ea;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        .product-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            position: relative; 
        }
        .product-item input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #c7c7cc;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .product-item input[type="checkbox"]:checked {
            background-color: #007aff; 
            border-color: #007aff;
        }
        .product-item input[type="checkbox"]:checked::before {
            content: 'âœ“';
            color: white;
            font-size: 14px;
            line-height: 18px;
            text-align: center;
            display: block;
        }
        .product-item label {
            display: flex;
            align-items: center;
            flex-grow: 1;
            font-size: 16px;
            color: #1c1c1e;
        }
        
        /* ç¼–è¾‘/åˆ é™¤æŒ‰é’®å®¹å™¨ */
        .product-actions {
            margin-left: 15px;
            display: flex;
            gap: 5px;
        }

        .action-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            color: #8e8e93; 
            transition: color 0.1s;
        }
        .action-button:hover {
            color: #5856d6;
        }
        .delete-button:hover {
            color: #ff3b30;
        }

        /* ç»“ç®—å’Œæ–°å¢æ§ä»¶ */
        .checkout-bar {
            text-align: center;
            margin-top: 40px;
        }
        .checkout-bar button {
            background-color: #34c759; 
            color: white;
            border: none;
            padding: 14px 40px;
            font-size: 17px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(52, 199, 89, 0.3);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .checkout-bar button:active {
            background-color: #2eaf4c;
            box-shadow: none;
        }
        
        .add-new-control {
            display: flex; 
            gap: 8px; 
            margin-top: 30px;
            padding: 15px;
            background-color: #f2f2f7; 
            border-radius: 12px;
            align-items: center;
        }
        .add-new-control input, .add-new-control select {
            padding: 10px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
            background-color: #ffffff; 
        }
        .add-new-control input {
            flex-grow: 1;
            -webkit-appearance: none; 
            appearance: none;
            min-width: 150px; 
        }
        .add-new-control select {
            width: 160px; 
            flex-shrink: 0;
            text-overflow: ellipsis; 
        }
        .add-new-control button {
            width: 120px; 
            background-color: #007aff; 
            color: white;
            border: none;
            padding: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            flex-shrink: 0;
            font-weight: 600;
        }

        /* 4. è´­ç‰©è½¦/ç»“ç®—é¡µé¢æ ·å¼ (åŒä¸Š) */
        #cart-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }
        #cart-table th, #cart-table td {
            padding: 12px 0;
            border-bottom: 1px solid #e5e5ea;
            text-align: left;
        }
        #cart-table th {
            font-weight: 600;
            color: #8e8e93;
            background: none; 
            border-bottom: 2px solid #d1d1d6;
        }
        
        .cart-item-row.purchased td {
            color: #aeaeb2; 
            background-color: transparent;
        }
        .cart-item-row.purchased .item-name {
            text-decoration: line-through;
        }

        .price-input {
            width: 130px; 
            padding: 6px 8px;
            border: 1px solid #d1d1d6;
            border-radius: 6px;
            text-align: right;
            font-size: 15px;
            background-color: #f9f9f9; 
            -webkit-appearance: none; 
            appearance: none;
        }
        
        /* æ€»è®¡æ˜¾ç¤º (Card Style) */
        #cart-total-display {
            font-size: 20px;
            font-weight: 700;
            margin-top: 30px;
            padding: 15px 20px;
            background-color: #e5e5ea; 
            border-radius: 12px;
            color: #3a3a3c;
            text-align: right;
            border: none;
        }
        
        /* æ‹·è´æŒ‰é’®æ ·å¼ */
        .copy-button {
            width: 100%;
            background-color: #007aff; 
            color: white;
            border: none;
            padding: 14px 0;
            font-size: 17px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3);
            margin-top: 20px;
            margin-bottom: 10px;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .copy-button:active {
            background-color: #005bb5;
            box-shadow: none;
        }

        /* çº¢è‰²æŒ‰é’® (Destructive Action) */
        .reset-button {
            background-color: #ff3b30; 
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(255, 59, 48, 0.3);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .reset-button:active {
            background-color: #d82b2b;
            box-shadow: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ›’ é‡‡è´­æ¸…å•</h1>

    <div class="tabs" id="tab-controls">
        <button class="tab-button active" data-tab="product-tab" onclick="openTab(event, 'product-tab')">ğŸ›ï¸ é€‰å“æ¸…å•</button>
        <button class="tab-button" data-tab="cart-tab" onclick="openTab(event, 'cart-tab')">ğŸ“‹ ç»“ç®—è´­ç‰©è½¦</button>
    </div>

    <div id="product-tab" class="tab-content active">
        <div id="product-list">
            </div>
        
        <div class="checkout-bar">
            <button onclick="addSelectedToCart()">âœ… åŠ å…¥è´­ç‰©è½¦å¹¶å‰å¾€ç»“ç®—</button>
        </div>
        
        <div class="add-new-control">
            <input type="text" id="new-product-input" placeholder="æ·»åŠ æ–°çš„é‡‡è´­é¡¹åˆ°æ¸…å•"> 
            <select id="new-product-category">
                </select>
            <button class="add-to-list-button" onclick="addNewProductToList()">æ·»åŠ åˆ°æ¸…å•</button>
        </div>
    </div>

    <div id="cart-tab" class="tab-content">
        <table id="cart-table">
            <thead>
                <tr>
                    <th style="width: 5%;">âœ“</th>
                    <th style="width: 65%;">é‡‡è´­å“é¡¹</th>
                    <th style="width: 30%; text-align: right;">ä»·æ ¼</th>
                </tr>
            </thead>
            <tbody id="cart-table-body">
                </tbody>
        </table>

        <div id="cart-total-display">
            æ€»æ”¯å‡º: Ks 0
        </div>
        
        <button class="copy-button" onclick="copyCartSummary()">ğŸ“‹ æ‹·è´é‡‡è´­æ¸…å•ä¸æ€»æ”¯å‡º</button>

        <button class="reset-button" onclick="resetCart()">æ¸…ç©ºè´­ç‰©è½¦ & é‡ç½®ä»·æ ¼</button>
    </div>
</div>

<script>
    // --- æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜ DOM å¼•ç”¨ ---
    const DOM = {
        productList: document.getElementById('product-list'),
        newProductCategory: document.getElementById('new-product-category'),
        newProductInput: document.getElementById('new-product-input'),
        cartTableBody: document.getElementById('cart-table-body'),
        cartTotalDisplay: document.getElementById('cart-total-display'),
    };

    // --- è´§å¸ç¬¦å·å¸¸é‡ ---
    const CURRENCY_SYMBOL = 'Ks'; 
    const CURRENCY_SUFFIX = ` ${CURRENCY_SYMBOL}`; 
    
    // ä½¿ç”¨ Intl.NumberFormat å®ç°åƒä½åˆ†éš”ç¬¦æ ¼å¼åŒ– (ä¸å¸¦å°æ•°)
    const formatter = new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 0, 
        maximumFractionDigits: 0
    });
    
    // --- åˆå§‹æ•°æ®æ¨¡æ¿ ---
    let procurementListTemplate = {
        'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©': [
            'é¸¡è‚‰', 'é¸¡è‚‰é¦™è‚ ', 'é¸¡ç¿…è†€', 'é¸¡è„š', 'é¸¡èƒ—', 'é¸¡è‚ å­', 'ç‰›è‚‰', 
            'ç¾Šè‚‰', 'çŒªæ’éª¨', 'çŒªçš®å­', 'çŒªè‚‰', 'äº”èŠ±è‚‰', 'é¦™è‚ å¤§å·', 
            'é±¼', 'è™¾å­', 'ç”Ÿèš', 'é¹Œé¹‘è›‹', 'ç‰›æ²¹'
        ],
        'è”¬èœ ğŸ¥¬': [
            'ç§‹è‘µ', 'èŒ„å­', 'éŸ­èœ', 'é‡‘é’ˆè‡', 'ç‰ç±³', 'åœŸè±†', 'ç²‘ç²‘', 'é˜¿è¾¾åº¦'
        ],
        'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„': [
            'è‘±å¶', 'å‘³äº‹è¾¾', 'è…Œèœè†', 'è¾£å­', 'å¤§è’œ', 'é±¼é’èœæ ¹', 'çƒŸå­', 
            'ç›ç¢', 'å§œ', 'éº»å°†åŒ…'
        ],
        'è€—æ/å…¶ä»–': [
            'çƒ§çƒ¤ç­¾', 'ç­·å­', 'æ‰“åŒ…å¸¦å°å·', 'ä¿é²œè†œ', 'ç«ç‚­'
        ]
    };

    /**
     * æ™ºèƒ½åˆ†ç±»å…³é”®å­—æ˜ å°„
     */
    const KEYWORD_MAP = {
        // è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©
        'é¸¡': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'ç‰›': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'çŒª': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©',
        'ç¾Š': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'é±¼': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'è™¾': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©',
        'æµ·é²œ': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'è‚‰': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©',
        // è”¬èœ ğŸ¥¬
        'èœ': 'è”¬èœ ğŸ¥¬', 'è‡': 'è”¬èœ ğŸ¥¬', 'æœ': 'è”¬èœ ğŸ¥¬', 'è±†': 'è”¬èœ ğŸ¥¬', 'æ¤’': 'è”¬èœ ğŸ¥¬',
        // è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„
        'æ–™': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'é…±': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'é†‹': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„',
        'æ²¹': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'è‘±': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'è’œ': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„',
        'ç›': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'å§œ': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„',
    };

    // --- æ ¸å¿ƒå˜é‡å’Œæœ¬åœ°å­˜å‚¨é”® ---
    let cartItems = []; 
    const PRODUCT_STORAGE_KEY = 'bbqProducts'; 
    const CART_STORAGE_KEY = 'bbqCart';      
    let grandTotalCost = 0; 

    // --- å®ç”¨å·¥å…·å‡½æ•° ---

    function parseFormattedPrice(formattedString) {
        if (!formattedString) return '';
        const cleanedString = String(formattedString).replace(/[^0-9]/g, '');
        return parseFloat(cleanedString) || '';
    }

    function formatPrice(number) {
        const num = parseFloat(number);
        if (isNaN(num) || num === 0) return '';
        return formatter.format(num) + CURRENCY_SUFFIX;
    }
    
    function getCategoryByKeyword(itemName) {
        for (const keyword in KEYWORD_MAP) {
            if (itemName.includes(keyword)) {
                return KEYWORD_MAP[keyword];
            }
        }
        return null; 
    }

    function sortCategory(categoryKey) {
        if (procurementListTemplate[categoryKey]) {
            procurementListTemplate[categoryKey].sort((a, b) => a.localeCompare(b, 'zh-CN'));
        }
    }

    // --- åˆå§‹åŒ–å’ŒåŠ è½½ ---

    document.addEventListener('DOMContentLoaded', () => {
        // ç¬¬ä¸€æ¬¡åŠ è½½æ—¶å¯¹æ‰€æœ‰ç°æœ‰æ•°æ®è¿›è¡Œæ’åº
        for (const category in procurementListTemplate) {
            sortCategory(category);
        }
        loadProducts(); 
        loadCart();     
        renderCart();   
        populateCategorySelect(); 
        openTab(null, 'product-tab'); 
    });

    function populateCategorySelect() {
        let optionsHtml = '';
        for (const category in procurementListTemplate) {
            optionsHtml += `<option value="${category}">${category}</option>`;
        }
        DOM.newProductCategory.innerHTML = optionsHtml;
        if (DOM.newProductCategory.options.length > 0) {
            DOM.newProductCategory.selectedIndex = 0;
        }
    }

    function openTab(evt, tabName) {
        let tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
            tabcontent[i].style.display = "none";
        }
        
        let tablinks = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        
        document.getElementById(tabName).classList.add("active");
        document.getElementById(tabName).style.display = "block";
        if (evt) {
            evt.currentTarget.classList.add("active");
        } else {
            document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add("active");
        }
    }
    
    // --- 1. ä¸‹å•é¡µé¢é€»è¾‘ (é€‰å“) - **æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒ** ---

    function renderProductList() {
        let listHtml = '';
        
        for (const category in procurementListTemplate) {
            sortCategory(category); 
            
            listHtml += `<h2>${category}</h2>`;

            const items = procurementListTemplate[category];
            // ä½¿ç”¨åŸç”Ÿ for å¾ªç¯è¿›è¡Œå¾®æ€§èƒ½ä¼˜åŒ–
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const uniqueId = `${category}-${item}`;
                
                // ç¡®ä¿ç‰¹æ®Šå­—ç¬¦è¢«æ­£ç¡®å¤„ç†ï¼Œé˜²æ­¢ XSS å’Œå‚æ•°é”™è¯¯
                const escapedCategory = category.replace(/'/g, "\\'");
                const escapedItem = item.replace(/'/g, "\\'");

                listHtml += `
                    <div class="product-item">
                        <input type="checkbox" id="item-${uniqueId}" data-item-name="${item}">
                        <label for="item-${uniqueId}" style="flex-grow:1; cursor:pointer;">${item}</label>
                        <div class="product-actions">
                            <button class="action-button edit-button" 
                                    onclick="editProduct('${escapedCategory}', '${escapedItem}')">
                                âœï¸
                            </button>
                            <button class="action-button delete-button" 
                                    onclick="deleteProduct('${escapedCategory}', '${escapedItem}')">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        // æ ¸å¿ƒä¼˜åŒ–ï¼šä¸€æ¬¡æ€§è®¾ç½® innerHTMLï¼Œå‡å°‘ DOM æ“ä½œæ¬¡æ•°
        DOM.productList.innerHTML = listHtml;
    }
    
    function editProduct(category, oldName) {
        const newName = prompt(`è¯·è¾“å…¥ "${oldName}" çš„æ–°åç§°ï¼š`, oldName);
        
        if (newName && newName.trim() !== oldName) {
            const trimmedNewName = newName.trim();
            
            // æ£€æŸ¥é‡å¤é¡¹
            let isDuplicate = false;
            for (const cat in procurementListTemplate) {
                if (procurementListTemplate[cat].includes(trimmedNewName)) {
                    isDuplicate = true;
                    break;
                }
            }

            if (isDuplicate) {
                alert(`"${trimmedNewName}" å·²ç»åœ¨æ¸…å•ä¸­ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°ï¼`);
                return;
            }
            
            // 1. æ›´æ–°é‡‡è´­æ¸…å•æ¨¡æ¿
            const list = procurementListTemplate[category];
            const oldIndex = list.indexOf(oldName);
            
            if (oldIndex !== -1) {
                list[oldIndex] = trimmedNewName;
                sortCategory(category);
                saveProducts();
                
                // 2. æ›´æ–°è´­ç‰©è½¦ä¸­çš„åç§°
                for (let i = 0; i < cartItems.length; i++) {
                    if (cartItems[i].name === oldName) {
                        cartItems[i].name = trimmedNewName;
                        break; // å‡è®¾å•†å“åæ˜¯å”¯ä¸€çš„
                    }
                }
                saveCart();
                
                // 3. é‡æ–°æ¸²æŸ“
                renderProductList();
                renderCart();
            }
        }
    }
    
    function deleteProduct(category, name) {
        if (confirm(`ç¡®å®šè¦ä»æ¸…å•ä¸­åˆ é™¤é‡‡è´­é¡¹ "${name}" å—ï¼Ÿæ­¤æ“ä½œå°†æ— æ³•æ’¤é”€ã€‚`)) {
            // 1. ä»é‡‡è´­æ¸…å•æ¨¡æ¿ä¸­åˆ é™¤
            const list = procurementListTemplate[category];
            const oldIndex = list.indexOf(name);
            
            if (oldIndex !== -1) {
                list.splice(oldIndex, 1);
                saveProducts();
                
                // 2. ä»è´­ç‰©è½¦ä¸­åˆ é™¤
                cartItems = cartItems.filter(item => item.name !== name);
                saveCart();
                
                // 3. é‡æ–°æ¸²æŸ“
                renderProductList();
                renderCart();
            }
        }
    }

    function addSelectedToCart() {
        const checkboxes = document.querySelectorAll('#product-list input[type="checkbox"]');
        let selectedCount = 0;
        
        // å¿«é€Ÿåˆ›å»ºæ—§è´­ç‰©è½¦é¡¹ç›®çš„æ˜ å°„ï¼Œä»¥ä¿ç•™ä»·æ ¼/çŠ¶æ€
        const oldCartMap = new Map();
        for (let i = 0; i < cartItems.length; i++) {
            const item = cartItems[i];
            oldCartMap.set(item.name, { purchased: item.purchased, price: item.price });
        }
        
        const newCartItems = [];

        for (let i = 0; i < checkboxes.length; i++) {
            const checkbox = checkboxes[i];
            if (checkbox.checked) {
                const itemName = checkbox.getAttribute('data-item-name');
                const existingItem = oldCartMap.get(itemName);
                
                newCartItems.push({
                    name: itemName,
                    purchased: existingItem ? existingItem.purchased : false,
                    price: existingItem ? existingItem.price : ''
                });
                selectedCount++;
            }
        }
        
        cartItems = newCartItems;

        if (selectedCount === 0) {
            alert("è¯·å…ˆå‹¾é€‰æ‚¨è¦é‡‡è´­çš„å•†å“ï¼");
            return;
        }

        saveCart();
        renderCart();
        
        openTab(null, 'cart-tab');
        alert(`æˆåŠŸæ·»åŠ  ${selectedCount} ä»¶å•†å“åˆ°è´­ç‰©è½¦ï¼Œè¯·åœ¨ç»“ç®—é¡µè®°å½•ä»·æ ¼ï¼`);
    }

    function addNewProductToList() {
        const itemName = DOM.newProductInput.value.trim();
        const selectedCategoryKey = DOM.newProductCategory.value;

        if (itemName === "") {
            alert("è¯·è¾“å…¥é‡‡è´­é¡¹åç§°ã€‚");
            return;
        }
        
        // 1. æ£€æŸ¥é‡å¤é¡¹
        for (const category in procurementListTemplate) {
            if (procurementListTemplate[category].includes(itemName)) {
                 alert(`"${itemName}" å·²ç»åœ¨æ¸…å•ä¸­ï¼`);
                 DOM.newProductInput.value = ''; 
                 DOM.newProductInput.focus();
                 return;
            }
        }

        // 2. ç¡®å®šç›®æ ‡åˆ†ç±»ï¼šæ™ºèƒ½åŒ¹é…ä¼˜å…ˆï¼Œå…¶æ¬¡æ˜¯ç”¨æˆ·é€‰æ‹©
        const smartCategoryKey = getCategoryByKeyword(itemName);
        const targetCategoryKey = smartCategoryKey || selectedCategoryKey;
        
        if (procurementListTemplate[targetCategoryKey]) {
             // 3. æ·»åŠ åˆ°ç›®æ ‡åˆ†ç±»
             procurementListTemplate[targetCategoryKey].push(itemName);
             
             // 4. ç«‹å³æ’åºè¯¥åˆ†ç±»
             sortCategory(targetCategoryKey); 
             
             saveProducts();
             renderProductList(); 
             
             // 5. è‡ªåŠ¨å‹¾é€‰æ–°æ·»åŠ çš„é¡¹ï¼ˆæ³¨æ„ï¼šè¿™æ¶‰åŠåˆ° DOM æŸ¥è¯¢ï¼Œæ— æ³•å®Œå…¨é¿å…ï¼‰
             const newCheckbox = document.querySelector(`input[data-item-name="${itemName}"]`);
             if (newCheckbox) newCheckbox.checked = true;
        } else {
            alert("é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°ç›®æ ‡åˆ†ç±»ã€‚");
        }
        
        DOM.newProductInput.value = ''; 
        DOM.newProductInput.focus();
    }


    // --- 2. è´­ç‰©è½¦é€»è¾‘ (ç»“ç®—å’Œä»·æ ¼è®°å½•) - **æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒ** ---
    
    function renderCart() {
        let tableHtml = '';
        
        if (cartItems.length === 0) {
            tableHtml = `<tr><td colspan="3" style="text-align: center; padding: 20px; color:#8e8e93;">è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œè¯·åœ¨é€‰å“æ¸…å•ä¸­å‹¾é€‰ï¼</td></tr>`;
        } else {
            for (let index = 0; index < cartItems.length; index++) {
                const item = cartItems[index];
                const purchasedClass = item.purchased ? 'purchased' : '';
                const checkedAttr = item.purchased ? 'checked' : '';
                const formattedPrice = formatPrice(item.price);

                tableHtml += `
                    <tr class="cart-item-row ${purchasedClass}">
                        <td>
                            <input type="checkbox" ${checkedAttr} onchange="togglePurchased(${index})">
                        </td>
                        <td><span class="item-name">${item.name}</span></td>
                        <td style="text-align: right;">
                            <input type="text" 
                                class="price-input" 
                                value="${formattedPrice}" 
                                placeholder="0 ${CURRENCY_SYMBOL}" 
                                inputmode="numeric" 
                                pattern="[0-9]*"
                                onfocus="this.value = parseFormattedPrice(this.value);"
                                onblur="updateItemPrice(${index}, this);"
                                onkeyup="formatInput(this)">
                        </td>
                    </tr>
                `;
            }
        }
        // æ ¸å¿ƒä¼˜åŒ–ï¼šä¸€æ¬¡æ€§è®¾ç½® innerHTMLï¼Œå‡å°‘ DOM æ“ä½œæ¬¡æ•°
        DOM.cartTableBody.innerHTML = tableHtml;
        
        calculateTotalCost();
    }
    
    function formatInput(inputElement) {
        let value = inputElement.value.replace(/[^0-9]/g, '');
        const number = parseFloat(value);
        if (isNaN(number)) {
            inputElement.value = '';
        } else {
            inputElement.value = formatter.format(number) + CURRENCY_SUFFIX;
        }
    }


    function updateItemPrice(index, inputElement) {
        // å¼ºåˆ¶ä½¿ç”¨ inputElement.value è·å–å½“å‰è¾“å…¥æ¡†ä¸­çš„å€¼
        const rawValue = parseFormattedPrice(inputElement.value);

        cartItems[index].price = rawValue; 
        
        // è‡ªåŠ¨æ‰“å‹¾
        const isPurchased = (rawValue !== '' && rawValue > 0);
        cartItems[index].purchased = isPurchased;
        
        // ç«‹å³æ›´æ–° input çš„æ˜¾ç¤ºå€¼
        inputElement.value = formatPrice(rawValue);

        saveCart();
        // ä»…åœ¨çŠ¶æ€æ”¹å˜æ—¶é‡ç»˜ä»¥å‡å°‘é‡ç»˜èŒƒå›´ï¼ˆä½†ä¸ºç®€å•èµ·è§ï¼Œè¿™é‡Œä¿æŒå…¨é‡é‡ç»˜ï¼‰
        renderCart(); 
    }


    function togglePurchased(index) {
        cartItems[index].purchased = !cartItems[index].purchased;
        if (!cartItems[index].purchased) {
            cartItems[index].price = '';
        }
        saveCart();
        calculateTotalCost(); 
        renderCart(); 
    }


    function calculateTotalCost() {
        let total = 0;
        // ä½¿ç”¨åŸç”Ÿ for å¾ªç¯è¿›è¡Œå¾®æ€§èƒ½ä¼˜åŒ–
        for (let i = 0; i < cartItems.length; i++) {
            const item = cartItems[i];
            const price = parseFloat(item.price);
            if (item.purchased && !isNaN(price) && price > 0) {
                 total += price;
            }
        }
        
        grandTotalCost = total; 
        
        // æ ¸å¿ƒä¼˜åŒ–ï¼šç¼“å­˜ DOM å¼•ç”¨ï¼Œå‡å°‘ DOM æŸ¥è¯¢
        DOM.cartTotalDisplay.textContent = `æ€»æ”¯å‡º: ${formatter.format(grandTotalCost)}${CURRENCY_SUFFIX}`;
    }
    
    async function copyCartSummary() {
        // è·å–å½“å‰æ—¥æœŸå¹¶æ ¼å¼åŒ–ä¸º YYYY-MM-DD
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const todayDate = `${year}-${month}-${day}`;

        let summaryText = `ğŸ“… ${todayDate} é‡‡è´­æ€»ç»“:\n\n`; 
        let hasPurchasedItems = false;
        
        // ä½¿ç”¨åŸç”Ÿ for å¾ªç¯è¿›è¡Œå¾®æ€§èƒ½ä¼˜åŒ–
        for (let i = 0; i < cartItems.length; i++) {
            const item = cartItems[i];
            const price = parseFormattedPrice(item.price);
            if (item.purchased && price !== '' && price > 0) {
                hasPurchasedItems = true;
                const formattedPrice = formatPrice(price);
                summaryText += `${item.name}: ${formattedPrice}\n`;
            }
        }
        
        if (!hasPurchasedItems) {
            alert("è¯·å…ˆåœ¨æ¸…å•ä¸­å‹¾é€‰å·²é‡‡è´­é¡¹ç›®å¹¶å¡«å†™ä»·æ ¼ï¼");
            return;
        }

        summaryText += "\n------------------\n";
        summaryText += `ğŸ’° æ€»æ”¯å‡º: ${formatter.format(grandTotalCost)}${CURRENCY_SUFFIX}`;
        
        try {
            if (navigator.clipboard) {
                await navigator.clipboard.writeText(summaryText);
                alert("ğŸ›’ é‡‡è´­æ¸…å• (å«æ—¥æœŸ) å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\næ‚¨å¯ä»¥å»ç²˜è´´ç»™å…¶ä»–äººäº†ã€‚");
            } else {
                // å…¼å®¹æ—§æµè§ˆå™¨çš„å¤åˆ¶æ–¹æ³•
                const textarea = document.createElement('textarea');
                textarea.value = summaryText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert("ğŸ›’ é‡‡è´­æ¸…å• (å«æ—¥æœŸ) å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\næ‚¨å¯ä»¥å»ç²˜è´´ç»™å…¶ä»–äººäº†ã€‚");
            }
        } catch (err) {
            console.error('æ— æ³•å¤åˆ¶å†…å®¹:', err);
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹å†…å®¹:\n\n' + summaryText);
        }
    }


    function resetCart() {
        if (confirm("ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å¹¶é‡ç½®ä»·æ ¼å—ï¼Ÿè¿™ä¼šæ¸…é™¤æ‰€æœ‰å½“å‰è®°å½•ï¼")) {
            cartItems = [];
            saveCart();
            renderCart();
            
            openTab(null, 'product-tab');
            // DOM æŸ¥è¯¢æ— æ³•é¿å…ï¼Œä½†ä»æ˜¯å¿…è¦æ“ä½œ
            document.querySelectorAll('#product-list input[type="checkbox"]').forEach(cb => cb.checked = false);
            alert("è´­ç‰©è½¦å·²æ¸…ç©ºï¼Œè¯·é‡æ–°é€‰è´­ï¼");
        }
    }

    // --- æœ¬åœ°å­˜å‚¨ (Local Storage) ---
    
    function saveProducts() {
         localStorage.setItem(PRODUCT_STORAGE_KEY, JSON.stringify(procurementListTemplate));
    }

    function loadProducts() {
        const savedProducts = localStorage.getItem(PRODUCT_STORAGE_KEY);
        if (savedProducts) {
             try {
                procurementListTemplate = JSON.parse(savedProducts);
             } catch(e) {
                 console.error("åŠ è½½äº§å“æ•°æ®å¤±è´¥:", e);
             }
        }
        renderProductList();
    }

    function saveCart() {
        const cartToSave = [];
        // ä½¿ç”¨åŸç”Ÿ for å¾ªç¯è¿›è¡Œå¾®æ€§èƒ½ä¼˜åŒ–
        for (let i = 0; i < cartItems.length; i++) {
            const item = cartItems[i];
            cartToSave.push({
                 ...item,
                 price: parseFormattedPrice(item.price) 
            });
        }
        localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cartToSave));
    }

    function loadCart() {
        const savedCart = localStorage.getItem(CART_STORAGE_KEY);
        if (savedCart) {
            try {
                const loadedCart = JSON.parse(savedCart);
                cartItems = [];
                // ä½¿ç”¨åŸç”Ÿ for å¾ªç¯è¿›è¡Œå¾®æ€§èƒ½ä¼˜åŒ–
                for (let i = 0; i < loadedCart.length; i++) {
                    const item = loadedCart[i];
                    cartItems.push({
                         ...item,
                         price: parseFormattedPrice(item.price)
                    });
                }
            } catch(e) {
                console.error("åŠ è½½è´­ç‰©è½¦æ•°æ®å¤±è´¥:", e);
            }
        }
    }
</script>
</body>
</html>