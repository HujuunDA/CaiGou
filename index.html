<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§é‡‡è´­ç®¡ç† (Ks) - äº‘åŒæ­¥ç‰ˆ</title>
    <style>
        /* 1. å…¨å±€å’Œå­—ä½“è®¾ç½® (Clear and Minimal) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            background-color: #f7f7f7; /* æµ…ç°è‰²èƒŒæ™¯ */
            color: #1c1c1e; /* æ·±è‰²æ–‡å­— */
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            background: #ffffff;
            padding: 30px;
            border-radius: 16px; /* æŸ”å’Œçš„åœ†è§’ */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); /* æè½»å¾®çš„é˜´å½± */
            transition: box-shadow 0.3s;
        }
        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #3a3a3c;
            text-align: center;
            margin-bottom: 25px;
        }
        
        /* 2. Tab åˆ‡æ¢æ ·å¼ (Segmented Control Style) */
        .tabs {
            display: flex;
            background-color: #f0f0f0; 
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 30px;
        }
        .tab-button {
            flex-grow: 1;
            padding: 10px 15px;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: 600;
            color: #8e8e93; 
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
        }
        .tab-button.active {
            background-color: #ffffff; 
            color: #1c1c1e; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
        }
        .tab-content {
            display: none;
            padding: 10px 0;
        }
        .tab-content.active {
            display: block;
        }

        /* 3. ä¸‹å•é¡µé¢ (é€‰å“) æ ·å¼ */
        #product-list h2 {
            font-size: 18px;
            font-weight: 600;
            color: #5856d6; 
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e5ea;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        .product-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            position: relative; 
        }
        .product-item input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #c7c7cc;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .product-item input[type="checkbox"]:checked {
            background-color: #007aff; 
            border-color: #007aff;
        }
        .product-item input[type="checkbox"]:checked::before {
            content: 'âœ“';
            color: white;
            font-size: 14px;
            line-height: 18px;
            text-align: center;
            display: block;
        }
        .product-item label {
            display: flex;
            align-items: center;
            flex-grow: 1;
            font-size: 16px;
            color: #1c1c1e;
        }
        
        /* ç¼–è¾‘/åˆ é™¤æŒ‰é’®å®¹å™¨ */
        .product-actions {
            margin-left: 15px;
            display: flex;
            gap: 5px;
        }

        .action-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            color: #8e8e93; 
            transition: color 0.1s;
        }
        .action-button:hover {
            color: #5856d6;
        }
        .delete-button:hover {
            color: #ff3b30;
        }

        /* ç»“ç®—å’Œæ–°å¢æ§ä»¶ */
        .checkout-bar {
            text-align: center;
            margin-top: 40px;
        }
        .checkout-bar button {
            background-color: #34c759; 
            color: white;
            border: none;
            padding: 14px 40px;
            font-size: 17px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(52, 199, 89, 0.3);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .checkout-bar button:active {
            background-color: #2eaf4c;
            box-shadow: none;
        }
        
        .add-new-control {
            display: flex; 
            gap: 8px; 
            margin-top: 30px;
            padding: 15px;
            background-color: #f2f2f7; 
            border-radius: 12px;
            align-items: center;
        }
        .add-new-control input, .add-new-control select {
            padding: 10px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
            background-color: #ffffff; 
        }
        .add-new-control input {
            flex-grow: 1;
            -webkit-appearance: none; 
            appearance: none;
            min-width: 150px; 
        }
        .add-new-control select {
            width: 160px; 
            flex-shrink: 0;
            text-overflow: ellipsis; 
        }
        .add-new-control button {
            width: 120px; 
            background-color: #007aff; 
            color: white;
            border: none;
            padding: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            flex-shrink: 0;
            font-weight: 600;
        }

        /* 4. è´­ç‰©è½¦/ç»“ç®—é¡µé¢æ ·å¼ (åŒä¸Š) */
        #cart-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }
        #cart-table th, #cart-table td {
            padding: 12px 0;
            border-bottom: 1px solid #e5e5ea;
            text-align: left;
        }
        #cart-table th {
            font-weight: 600;
            color: #8e8e93;
            background: none; 
            border-bottom: 2px solid #d1d1d6;
        }
        
        .cart-item-row.purchased td {
            color: #aeaeb2; 
            background-color: transparent;
        }
        .cart-item-row.purchased .item-name {
            text-decoration: line-through;
        }

        .price-input {
            width: 130px; 
            padding: 6px 8px;
            border: 1px solid #d1d1d6;
            border-radius: 6px;
            text-align: right;
            font-size: 15px;
            background-color: #f9f9f9; 
            -webkit-appearance: none; 
            appearance: none;
        }
        
        /* æ€»è®¡æ˜¾ç¤º (Card Style) */
        #cart-total-display {
            font-size: 20px;
            font-weight: 700;
            margin-top: 30px;
            padding: 15px 20px;
            background-color: #e5e5ea; 
            border-radius: 12px;
            color: #3a3a3c;
            text-align: right;
            border: none;
        }
        
        /* æ‹·è´æŒ‰é’®æ ·å¼ */
        .copy-button {
            width: 100%;
            background-color: #007aff; 
            color: white;
            border: none;
            padding: 14px 0;
            font-size: 17px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3);
            margin-top: 20px;
            margin-bottom: 10px;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .copy-button:active {
            background-color: #005bb5;
            box-shadow: none;
        }

        /* çº¢è‰²æŒ‰é’® (Destructive Action) */
        .reset-button {
            background-color: #ff3b30; 
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(255, 59, 48, 0.3);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .reset-button:active {
            background-color: #d82b2b;
            box-shadow: none;
        }
        
        /* åŠ è½½æç¤ºæ ·å¼ */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            color: #007aff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: 600;
            z-index: 1000;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    æ­£åœ¨ä»äº‘ç«¯åŠ è½½é‡‡è´­æ¸…å•... ğŸš€
</div>

<div class="container">
    <h1>ğŸ›’ é‡‡è´­æ¸…å•</h1>

    <div class="tabs" id="tab-controls">
        <button class="tab-button active" data-tab="product-tab" onclick="openTab(event, 'product-tab')">ğŸ›ï¸ é€‰å“æ¸…å•</button>
        <button class="tab-button" data-tab="cart-tab" onclick="openTab(event, 'cart-tab')">ğŸ“‹ ç»“ç®—è´­ç‰©è½¦</button>
    </div>

    <div id="product-tab" class="tab-content active">
        <div id="product-list">
            </div>
        
        <div class="checkout-bar">
            <button onclick="addSelectedToCart()">âœ… åŠ å…¥è´­ç‰©è½¦å¹¶å‰å¾€ç»“ç®—</button>
        </div>
        
        <div class="add-new-control">
            <input type="text" id="new-product-input" placeholder="æ·»åŠ æ–°çš„é‡‡è´­é¡¹åˆ°æ¸…å•"> 
            <select id="new-product-category">
                </select>
            <button class="add-to-list-button" onclick="addNewProductToList()">æ·»åŠ åˆ°æ¸…å•</button>
        </div>
    </div>

    <div id="cart-tab" class="tab-content">
        <table id="cart-table">
            <thead>
                <tr>
                    <th style="width: 5%;">âœ“</th>
                    <th style="width: 65%;">é‡‡è´­å“é¡¹</th>
                    <th style="width: 30%; text-align: right;">ä»·æ ¼</th>
                </tr>
            </thead>
            <tbody id="cart-table-body">
                </tbody>
        </table>

        <div id="cart-total-display">
            æ€»æ”¯å‡º: Ks 0
        </div>
        
        <button class="copy-button" onclick="copyCartSummary()">ğŸ“‹ æ‹·è´é‡‡è´­æ¸…å•ä¸æ€»æ”¯å‡º</button>

        <button class="reset-button" onclick="resetCart()">æ¸…ç©ºè´­ç‰©è½¦ & é‡ç½®ä»·æ ¼</button>
    </div>
</div>

<script>
    // *********************************************************************************
    // *** æ ¸å¿ƒä¿®æ”¹ï¼šäº‘åŒæ­¥é…ç½® - å·²ä¸ºæ‚¨å¡«å…¥æ‚¨çš„ Bin ID å’Œ Master Key ***
    // *********************************************************************************
    const JSONBIN_ID = '6914d01eae596e708f552007'; 
    const JSONBIN_MASTER_KEY = '$2a$10$IpDKTR7rokm3XA7rNEmLoeaqE9aZxj2Vu23VSYCVN7Hj5q8V1X25.'; 
    const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;
    
    // --- æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜ DOM å¼•ç”¨ ---
    const DOM = {
        productList: document.getElementById('product-list'),
        newProductCategory: document.getElementById('new-product-category'),
        newProductInput: document.getElementById('new-product-input'),
        cartTableBody: document.getElementById('cart-table-body'),
        cartTotalDisplay: document.getElementById('cart-total-display'),
        loadingOverlay: document.getElementById('loading-overlay'),
    };

    // --- è´§å¸ç¬¦å·å¸¸é‡ ---
    const CURRENCY_SYMBOL = 'Ks'; 
    const CURRENCY_SUFFIX = ` ${CURRENCY_SYMBOL}`; 
    
    const formatter = new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 0, 
        maximumFractionDigits: 0
    });
    
    // æ ¸å¿ƒä¿®æ”¹ï¼šç»Ÿä¸€ç®¡ç†äº‘ç«¯æ•°æ®ç»“æ„
    let cloudData = {
        productTemplate: {}, // ä¸»æ¸…å•
        cartData: []         // è´­ç‰©è½¦æ•°æ®
    };
    
    let grandTotalCost = 0; 

    // --- æ™ºèƒ½åˆ†ç±»å…³é”®å­—æ˜ å°„ ---
    const KEYWORD_MAP = {
        // è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©
        'é¸¡': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'ç‰›': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'çŒª': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©',
        'ç¾Š': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'é±¼': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'è™¾': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©',
        'æµ·é²œ': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©', 'è‚‰': 'è‚‰ç±»/æµ·é²œ ğŸ¦ğŸ¥©',
        // è”¬èœ ğŸ¥¬
        'èœ': 'è”¬èœ ğŸ¥¬', 'è‡': 'è”¬èœ ğŸ¥¬', 'æœ': 'è”¬èœ ğŸ¥¬', 'è±†': 'è”¬èœ ğŸ¥¬', 'æ¤’': 'è”¬èœ ğŸ¥¬',
        // è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„
        'æ–™': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'é…±': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'é†‹': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„',
        'æ²¹': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'è‘±': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'è’œ': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„',
        'ç›': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„', 'å§œ': 'è°ƒæ–™/é…±æ–™ ğŸ§‚ğŸ§„',
    };

    // --- äº‘åŒæ­¥å‡½æ•° (æ›´æ–°) ---
    
    /**
     * ä» JSONBin åŠ è½½é‡‡è´­æ¸…å•å’Œè´­ç‰©è½¦æ•°æ®
     */
    async function loadProductsFromCloud() {
        if (!JSONBIN_ID || !JSONBIN_MASTER_KEY) {
             cloudData = { productTemplate: {}, cartData: [] };
             DOM.loadingOverlay.textContent = "â— é”™è¯¯ï¼šé…ç½®ä¿¡æ¯ä¸¢å¤±ã€‚";
             return;
        }

        try {
            const response = await fetch(JSONBIN_URL, {
                method: 'GET',
                headers: {
                    'X-Master-Key': JSONBIN_MASTER_KEY
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}. è¯·æ£€æŸ¥ Bin æ˜¯å¦è®¾ç½®ä¸º Publicã€‚`);
            }

            const json = await response.json();
            
            // æ ¸å¿ƒä¿®æ”¹ï¼šæ£€æŸ¥æ–°çš„åŒé‡ç»“æ„
            if (json && json.record && json.record.productTemplate && Array.isArray(json.record.cartData)) {
                cloudData.productTemplate = json.record.productTemplate;
                cloudData.cartData = json.record.cartData;
            } else if (json && json.record && typeof json.record === 'object') {
                // å¦‚æœæ˜¯æ—§çš„å•å±‚ç»“æ„ï¼Œå°è¯•å…¼å®¹ï¼Œå¹¶æç¤ºç”¨æˆ·éœ€è¦æ›´æ–°JSONBinç»“æ„
                cloudData.productTemplate = json.record;
                cloudData.cartData = [];
                console.warn('äº‘ç«¯æ•°æ®ç»“æ„ä¸ºæ—§ç‰ˆæœ¬ï¼Œè¯·åœ¨ JSONBin ä¸­æ›´æ–°ä¸ºåŒ…å« productTemplate å’Œ cartData çš„æ–°ç»“æ„ã€‚');
            } else {
                throw new Error('äº‘ç«¯æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚');
            }
        } catch (error) {
            console.error('åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Bin IDã€Master Key æˆ– Bin æƒé™:', error);
            DOM.loadingOverlay.textContent = "âŒ åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æˆ– Bin æƒé™ã€‚";
            alert("åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥ï¼è¯·æ£€æŸ¥ JSONBin é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œç‰¹åˆ«æ˜¯ Bin æ˜¯å¦ä¸º Publicã€‚");
        } finally {
            // æ¸²æŸ“æ‰€æœ‰æ•°æ®
            for (const category in cloudData.productTemplate) {
                sortCategory(category);
            }
            renderProductList();
            populateCategorySelect();
            renderCart(); // æ–°å¢ï¼šåŠ è½½åç«‹å³æ¸²æŸ“è´­ç‰©è½¦
            
            // éšè—åŠ è½½å±‚
            DOM.loadingOverlay.style.opacity = '0';
            setTimeout(() => DOM.loadingOverlay.style.display = 'none', 300);
        }
    }

    /**
     * å°†é‡‡è´­æ¸…å•å’Œè´­ç‰©è½¦æ•°æ®ä¸€èµ·ä¸Šä¼ åˆ° JSONBin
     */
    async function saveProductsToCloud() {
        if (!JSONBIN_ID || !JSONBIN_MASTER_KEY) return;
        
        // æ ¸å¿ƒä¿®æ”¹ï¼šä¿å­˜æ•´ä¸ª cloudData å¯¹è±¡
        const dataToSave = cloudData; 

        try {
            const response = await fetch(JSONBIN_URL, {
                method: 'PUT', 
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': JSONBIN_MASTER_KEY, 
                    'X-Bin-Versioning': 'false' 
                },
                body: JSON.stringify(dataToSave)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        } catch (error) {
            console.error('ä¿å­˜äº‘ç«¯æ•°æ®å¤±è´¥:', error);
            alert("è­¦å‘Šï¼šæ•°æ®ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– Master Key æ˜¯å¦æœ‰å†™å…¥æƒé™ã€‚");
        }
    }
    
    // --- å®ç”¨å·¥å…·å‡½æ•° ---

    function parseFormattedPrice(formattedString) {
        if (!formattedString) return '';
        const cleanedString = String(formattedString).replace(/[^0-9]/g, '');
        return parseFloat(cleanedString) || '';
    }

    function formatPrice(number) {
        const num = parseFloat(number);
        if (isNaN(num) || num === 0) return '';
        return formatter.format(num) + CURRENCY_SUFFIX;
    }
    
    function getCategoryByKeyword(itemName) {
        for (const keyword in KEYWORD_MAP) {
            if (itemName.includes(keyword)) {
                return KEYWORD_MAP[keyword];
            }
        }
        return null; 
    }

    function sortCategory(categoryKey) {
        if (cloudData.productTemplate[categoryKey]) {
            cloudData.productTemplate[categoryKey].sort((a, b) => a.localeCompare(b, 'zh-CN'));
        }
    }

    // --- åˆå§‹åŒ–å’ŒåŠ è½½ ---

    document.addEventListener('DOMContentLoaded', () => {
        // åªéœ€è¦ä»äº‘ç«¯åŠ è½½ä¸€æ¬¡
        loadProductsFromCloud(); 
        
        // åˆå§‹æ‰“å¼€é€‰å“é¡µé¢
        openTab(null, 'product-tab');
    });

    function populateCategorySelect() {
        let optionsHtml = '';
        for (const category in cloudData.productTemplate) {
            optionsHtml += `<option value="${category}">${category}</option>`;
        }
        DOM.newProductCategory.innerHTML = optionsHtml;
        if (DOM.newProductCategory.options.length > 0) {
            DOM.newProductCategory.selectedIndex = 0;
        }
    }

    function openTab(evt, tabName) {
        let tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
            tabcontent[i].style.display = "none";
        }
        
        let tablinks = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        
        document.getElementById(tabName).classList.add("active");
        document.getElementById(tabName).style.display = "block";
        if (evt) {
            evt.currentTarget.classList.add("active");
        } else {
            // å¤„ç†é¦–æ¬¡åŠ è½½æ—¶ evt ä¸º null çš„æƒ…å†µ
            const initialTabButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
            if (initialTabButton) initialTabButton.classList.add("active");
        }
        
        // æ ¸å¿ƒä¿®æ”¹ï¼šæ¯æ¬¡åˆ‡æ¢åˆ°è´­ç‰©è½¦æ—¶ï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“ä¸€æ¬¡ï¼Œä»¥ä¿è¯æ•°æ®åŒæ­¥
        if (tabName === 'cart-tab') {
            loadProductsFromCloud(); // é‡æ–°åŠ è½½äº‘ç«¯æ•°æ®
        }
    }
    
    // --- 1. ä¸‹å•é¡µé¢é€»è¾‘ (é€‰å“) ---

    function renderProductList() {
        let listHtml = '';
        
        for (const category in cloudData.productTemplate) {
            // æ€§èƒ½ä¼˜åŒ–ï¼šç¡®ä¿æ¯æ¬¡æ¸²æŸ“å‰éƒ½æ’åº
            sortCategory(category); 
            
            listHtml += `<h2>${category}</h2>`;

            const items = cloudData.productTemplate[category];
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const uniqueId = `${category}-${item}`;
                
                const escapedCategory = category.replace(/'/g, "\\'");
                const escapedItem = item.replace(/'/g, "\\'");

                listHtml += `
                    <div class="product-item">
                        <input type="checkbox" id="item-${uniqueId}" data-item-name="${item}">
                        <label for="item-${uniqueId}" style="flex-grow:1; cursor:pointer;">${item}</label>
                        <div class="product-actions">
                            <button class="action-button edit-button" 
                                    onclick="editProduct('${escapedCategory}', '${escapedItem}')">
                                âœï¸
                            </button>
                            <button class="action-button delete-button" 
                                    onclick="deleteProduct('${escapedCategory}', '${escapedItem}')">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        DOM.productList.innerHTML = listHtml;
    }
    
    // *** æ•°æ®æ›´æ–°åéœ€è¦è°ƒç”¨ saveProductsToCloud() ***
    async function editProduct(category, oldName) {
        const newName = prompt(`è¯·è¾“å…¥ "${oldName}" çš„æ–°åç§°ï¼š`, oldName);
        
        if (newName && newName.trim() !== oldName) {
            const trimmedNewName = newName.trim();
            
            let isDuplicate = false;
            for (const cat in cloudData.productTemplate) {
                if (cloudData.productTemplate[cat].includes(trimmedNewName)) {
                    isDuplicate = true;
                    break;
                }
            }

            if (isDuplicate) {
                alert(`"${trimmedNewName}" å·²ç»åœ¨æ¸…å•ä¸­ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°ï¼`);
                return;
            }
            
            const list = cloudData.productTemplate[category];
            const oldIndex = list.indexOf(oldName);
            
            if (oldIndex !== -1) {
                list[oldIndex] = trimmedNewName;
                sortCategory(category);
                
                // æ ¸å¿ƒä¿®æ”¹ï¼šåŒæ­¥æ›´æ–°è´­ç‰©è½¦ä¸­çš„é¡¹ç›®åç§°
                for (let i = 0; i < cloudData.cartData.length; i++) {
                    if (cloudData.cartData[i].name === oldName) {
                        cloudData.cartData[i].name = trimmedNewName;
                        break; 
                    }
                }
                
                await saveProductsToCloud();
                
                renderProductList();
                renderCart();
            }
        }
    }
    
    // *** æ•°æ®æ›´æ–°åéœ€è¦è°ƒç”¨ saveProductsToCloud() ***
    async function deleteProduct(category, name) {
        if (confirm(`ç¡®å®šè¦ä»æ¸…å•ä¸­åˆ é™¤é‡‡è´­é¡¹ "${name}" å—ï¼Ÿæ­¤æ“ä½œå°†æ— æ³•æ’¤é”€ã€‚`)) {
            const list = cloudData.productTemplate[category];
            const oldIndex = list.indexOf(name);
            
            if (oldIndex !== -1) {
                list.splice(oldIndex, 1);
                
                // æ ¸å¿ƒä¿®æ”¹ï¼šåŒæ­¥ç§»é™¤è´­ç‰©è½¦ä¸­çš„é¡¹ç›®
                cloudData.cartData = cloudData.cartData.filter(item => item.name !== name);
                
                await saveProductsToCloud();
                
                renderProductList();
                renderCart();
            }
        }
    }

    async function addSelectedToCart() {
        const checkboxes = document.querySelectorAll('#product-list input[type="checkbox"]');
        let selectedCount = 0;
        
        // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨äº‘ç«¯æ•°æ®ä½œä¸ºæ—§è´­ç‰©è½¦
        const oldCartMap = new Map();
        for (let i = 0; i < cloudData.cartData.length; i++) {
            const item = cloudData.cartData[i];
            oldCartMap.set(item.name, { purchased: item.purchased, price: item.price });
        }
        
        const newCartItems = [];

        for (let i = 0; i < checkboxes.length; i++) {
            const checkbox = checkboxes[i];
            if (checkbox.checked) {
                const itemName = checkbox.getAttribute('data-item-name');
                const existingItem = oldCartMap.get(itemName);
                
                newCartItems.push({
                    name: itemName,
                    // æ ¸å¿ƒä¿®æ”¹ï¼šä¿æŒæ—§çš„è´­ä¹°çŠ¶æ€å’Œä»·æ ¼ï¼Œå®ç°è·¨è®¾å¤‡è®°å¿†
                    purchased: existingItem ? existingItem.purchased : false,
                    price: existingItem ? existingItem.price : ''
                });
                selectedCount++;
            }
        }
        
        cloudData.cartData = newCartItems; // æ›´æ–°äº‘ç«¯è´­ç‰©è½¦æ•°æ®
        
        if (selectedCount === 0) {
            alert("è¯·å…ˆå‹¾é€‰æ‚¨è¦é‡‡è´­çš„å•†å“ï¼");
            return;
        }
        
        await saveProductsToCloud(); // ä¿å­˜åˆ°äº‘ç«¯
        
        renderCart();
        
        openTab(null, 'cart-tab');
        alert(`æˆåŠŸæ·»åŠ  ${selectedCount} ä»¶å•†å“åˆ°è´­ç‰©è½¦ï¼Œè¯·åœ¨ç»“ç®—é¡µè®°å½•ä»·æ ¼ï¼`);
    }

    // *** æ•°æ®æ›´æ–°åéœ€è¦è°ƒç”¨ saveProductsToCloud() ***
    async function addNewProductToList() {
        const itemName = DOM.newProductInput.value.trim();
        const selectedCategoryKey = DOM.newProductCategory.value;

        if (itemName === "") {
            alert("è¯·è¾“å…¥é‡‡è´­é¡¹åç§°ã€‚");
            return;
        }
        
        // 1. æ£€æŸ¥é‡å¤é¡¹
        for (const category in cloudData.productTemplate) {
            if (cloudData.productTemplate[category].includes(itemName)) {
                 alert(`"${itemName}" å·²ç»åœ¨æ¸…å•ä¸­ï¼`);
                 DOM.newProductInput.value = ''; 
                 DOM.newProductInput.focus();
                 return;
            }
        }

        // 2. ç¡®å®šç›®æ ‡åˆ†ç±»
        const smartCategoryKey = getCategoryByKeyword(itemName);
        const targetCategoryKey = smartCategoryKey || selectedCategoryKey;
        
        // ç¡®ä¿ç›®æ ‡åˆ†ç±»å­˜åœ¨
        if (cloudData.productTemplate[targetCategoryKey]) {
             // 3. æ·»åŠ åˆ°ç›®æ ‡åˆ†ç±»
             cloudData.productTemplate[targetCategoryKey].push(itemName);
             
             // 4. ç«‹å³æ’åºè¯¥åˆ†ç±»
             sortCategory(targetCategoryKey); 
             
             // æ ¸å¿ƒä¿®æ”¹ï¼šä¿å­˜åˆ°äº‘ç«¯
             await saveProductsToCloud();
             
             renderProductList(); 
             
             // 5. è‡ªåŠ¨å‹¾é€‰æ–°æ·»åŠ çš„é¡¹
             const newCheckbox = document.querySelector(`input[data-item-name="${itemName}"]`);
             if (newCheckbox) newCheckbox.checked = true;
        } else {
            alert("é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°ç›®æ ‡åˆ†ç±»ã€‚");
        }
        
        DOM.newProductInput.value = ''; 
        DOM.newProductInput.focus();
    }


    // --- 2. è´­ç‰©è½¦é€»è¾‘ (ç»“ç®—å’Œä»·æ ¼è®°å½•) ---
    
    function renderCart() {
        let tableHtml = '';
        
        // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨äº‘ç«¯è´­ç‰©è½¦æ•°æ®
        const cartItems = cloudData.cartData; 

        if (cartItems.length === 0) {
            tableHtml = `<tr><td colspan="3" style="text-align: center; padding: 20px; color:#8e8e93;">è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œè¯·åœ¨é€‰å“æ¸…å•ä¸­å‹¾é€‰ï¼</td></tr>`;
        } else {
            for (let index = 0; index < cartItems.length; index++) {
                const item = cartItems[index];
                const purchasedClass = item.purchased ? 'purchased' : '';
                const checkedAttr = item.purchased ? 'checked' : '';
                const formattedPrice = formatPrice(item.price);

                tableHtml += `
                    <tr class="cart-item-row ${purchasedClass}">
                        <td>
                            <input type="checkbox" ${checkedAttr} onchange="togglePurchased(${index})">
                        </td>
                        <td><span class="item-name">${item.name}</span></td>
                        <td style="text-align: right;">
                            <input type="text" 
                                class="price-input" 
                                value="${formattedPrice}" 
                                placeholder="0 ${CURRENCY_SYMBOL}" 
                                inputmode="numeric" 
                                pattern="[0-9]*"
                                onfocus="this.value = parseFormattedPrice(this.value);"
                                onblur="updateItemPrice(${index}, this);"
                                onkeyup="formatInput(this)">
                        </td>
                    </tr>
                `;
            }
        }
        DOM.cartTableBody.innerHTML = tableHtml;
        calculateTotalCost();
    }
    
    function formatInput(inputElement) {
        let value = inputElement.value.replace(/[^0-9]/g, '');
        const number = parseFloat(value);
        if (isNaN(number)) {
            inputElement.value = '';
        } else {
            inputElement.value = formatter.format(number) + CURRENCY_SUFFIX;
        }
    }

    async function updateItemPrice(index, inputElement) {
        const rawValue = parseFormattedPrice(inputElement.value);
        const cartItems = cloudData.cartData;

        cartItems[index].price = rawValue; 
        
        const isPurchased = (rawValue !== '' && rawValue > 0);
        cartItems[index].purchased = isPurchased;
        
        inputElement.value = formatPrice(rawValue);

        await saveProductsToCloud(); // æ ¸å¿ƒä¿®æ”¹ï¼šä¿å­˜åˆ°äº‘ç«¯
        renderCart(); 
    }

    async function togglePurchased(index) {
        const cartItems = cloudData.cartData;
        
        cartItems[index].purchased = !cartItems[index].purchased;
        if (!cartItems[index].purchased) {
            cartItems[index].price = '';
        }
        
        await saveProductsToCloud(); // æ ¸å¿ƒä¿®æ”¹ï¼šä¿å­˜åˆ°äº‘ç«¯
        
        calculateTotalCost(); 
        renderCart(); 
    }

    function calculateTotalCost() {
        let total = 0;
        const cartItems = cloudData.cartData;
        
        for (let i = 0; i < cartItems.length; i++) {
            const item = cartItems[i];
            const price = parseFloat(item.price);
            if (item.purchased && !isNaN(price) && price > 0) {
                 total += price;
            }
        }
        
        grandTotalCost = total; 
        DOM.cartTotalDisplay.textContent = `æ€»æ”¯å‡º: ${formatter.format(grandTotalCost)}${CURRENCY_SUFFIX}`;
    }
    
    async function copyCartSummary() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const todayDate = `${year}-${month}-${day}`;

        let summaryText = `ğŸ“… ${todayDate} é‡‡è´­æ€»ç»“:\n\n`; 
        let hasPurchasedItems = false;
        const cartItems = cloudData.cartData;
        
        for (let i = 0; i < cartItems.length; i++) {
            const item = cartItems[i];
            const price = parseFormattedPrice(item.price);
            if (item.purchased && price !== '' && price > 0) {
                hasPurchasedItems = true;
                const formattedPrice = formatPrice(price);
                summaryText += `${item.name}: ${formattedPrice}\n`;
            }
        }
        
        if (!hasPurchasedItems) {
            alert("è¯·å…ˆåœ¨æ¸…å•ä¸­å‹¾é€‰å·²é‡‡è´­é¡¹ç›®å¹¶å¡«å†™ä»·æ ¼ï¼");
            return;
        }

        summaryText += "\n------------------\n";
        summaryText += `ğŸ’° æ€»æ”¯å‡º: ${formatter.format(grandTotalCost)}${CURRENCY_SUFFIX}`;
        
        try {
            if (navigator.clipboard) {
                await navigator.clipboard.writeText(summaryText);
                alert("ğŸ›’ é‡‡è´­æ¸…å• (å«æ—¥æœŸ) å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = summaryText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert("ğŸ›’ é‡‡è´­æ¸…å• (å«æ—¥æœŸ) å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
            }
        } catch (err) {
            console.error('æ— æ³•å¤åˆ¶å†…å®¹:', err);
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹å†…å®¹:\n\n' + summaryText);
        }
    }

    async function resetCart() {
        if (confirm("ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å¹¶é‡ç½®ä»·æ ¼å—ï¼Ÿè¿™ä¼šæ¸…é™¤æ‰€æœ‰å½“å‰è®°å½•ï¼")) {
            cloudData.cartData = [];
            
            await saveProductsToCloud(); // æ ¸å¿ƒä¿®æ”¹ï¼šä¿å­˜åˆ°äº‘ç«¯
            
            renderCart();
            
            openTab(null, 'product-tab');
            // æ¸…é™¤é€‰å“é¡µçš„å‹¾é€‰çŠ¶æ€ (å› ä¸ºå®ƒä»¬æ˜¯æ ¹æ®è´­ç‰©è½¦çŠ¶æ€æ¥è®°å¿†çš„ï¼Œç°åœ¨è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥ç†è®ºä¸Šæ— éœ€é¢å¤–æ“ä½œ)
            document.querySelectorAll('#product-list input[type="checkbox"]').forEach(cb => cb.checked = false);
            alert("è´­ç‰©è½¦å·²æ¸…ç©ºï¼Œè¯·é‡æ–°é€‰è´­ï¼");
        }
    }
    
    // ç§»é™¤æœ¬åœ°å­˜å‚¨å‡½æ•° loadCart/saveCartï¼Œå› ä¸ºæ•°æ®ç°åœ¨éƒ½åœ¨äº‘ç«¯ç®¡ç†
</script>
</body>
</html>
